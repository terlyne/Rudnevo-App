{% extends "panel/base.html" %}

{% block title %}
–†—É–¥–Ω–µ–≤–æ - –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/panel/schedule/schedule_list.css') }}">
{% endblock %}

{% block container %}
<div class="schedule-container">
    <div class="schedule-header">
        <div class="header-content">
            <h1>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h1>
        </div>
        <div class="schedule-actions">
            <button id="uploadBtn" class="btn btn-primary" style="display: none;">
                <span class="btn-icon">+</span>
                –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel —Ñ–∞–π–ª
            </button>
            <button id="deleteBtn" class="btn btn-danger" style="display: none;">
                <span class="btn-icon">üóëÔ∏è</span>
                –£–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            </button>
        </div>
    </div>

    <div id="scheduleContent">
        {% if has_schedules %}
            <div class="colleges-list">
                {% for template in templates %}
                <div class="college-item" data-college="{{ template.college_name }}" data-id="{{ template.id }}">
                    <span class="college-name">{{ template.college_name }}</span>
                </div>
                {% endfor %}
            </div>
            <div class="schedule-display-area" id="scheduleDisplayArea">
                {{ schedule_html|safe }}
            </div>
            
            <!-- –°–∫—Ä—ã—Ç—ã–µ –±–ª–æ–∫–∏ —Å HTML –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–ª–ª–µ–¥–∂–∞ -->
            {% for template in templates %}
            <div class="college-schedule-html" data-college="{{ template.college_name }}" style="display: none;">
                {% if template.html_content %}
                    {{ template.html_content|safe }}
                {% else %}
                    <div class="error">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è {{ template.college_name }} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="no-schedules">
                <div class="no-schedules-icon">üìä</div>
                <div class="no-schedules-text">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                <div class="no-schedules-subtext">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è–º–∏</div>
            </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
            <span class="close" onclick="closeDeleteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-danger" onclick="confirmDeleteAll()">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/panel/schedule/schedule_list.js') }}"></script>
<script>
    let currentSchedule = null;

    document.addEventListener('DOMContentLoaded', function () {
        console.log('=== SCHEDULE LIST PAGE LOADED ===');
        
        // –û—Ç–ª–∞–¥–∫–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ ID —à–∞–±–ª–æ–Ω–æ–≤
        const collegeItems = document.querySelectorAll('.college-item');
        console.log(`Found ${collegeItems.length} college items`);
        collegeItems.forEach((item, index) => {
            const id = item.getAttribute('data-id');
            const college = item.getAttribute('data-college');
            console.log(`Item ${index}: ID=${id}, College=${college}`);
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
        updateButtonVisibility();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        const uploadBtn = document.getElementById('uploadBtn');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', function () {
                window.location.href = '{{ url_for("panel.upload_schedule_template") }}';
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        const deleteBtn = document.getElementById('deleteBtn');
        if (deleteBtn) {
            console.log('Delete button found, adding event listener');
            deleteBtn.addEventListener('click', function () {
                console.log('Delete button clicked');
                deleteAllSchedules();
            });
        } else {
            console.error('Delete button not found');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–ª–ª–µ–¥–∂–µ–π
        document.querySelectorAll('.college-item').forEach(item => {
            item.addEventListener('click', function () {
                const collegeName = this.getAttribute('data-college');
                showSchedule(collegeName, this);
            });
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –∫–æ–ª–ª–µ–¥–∂
        const firstCollege = document.querySelector('.college-item');
        if (firstCollege) {
            firstCollege.classList.add('active');
        }
    });

    function updateButtonVisibility() {
        const hasSchedules = document.querySelectorAll('.college-item').length > 0;
        const uploadBtn = document.getElementById('uploadBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        
        if (hasSchedules) {
            if (uploadBtn) uploadBtn.style.display = 'none';
            if (deleteBtn) deleteBtn.style.display = 'inline-flex';
        } else {
            if (uploadBtn) uploadBtn.style.display = 'inline-flex';
            if (deleteBtn) deleteBtn.style.display = 'none';
        }
    }

    function showSchedule(collegeName, element) {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        document.querySelectorAll('.college-item').forEach(item => {
            item.classList.remove('active');
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
        if (element) {
            element.classList.add('active');
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        const displayArea = document.getElementById('scheduleDisplayArea');
        displayArea.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>';

        // –ò—â–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π HTML –±–ª–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–ª–ª–µ–¥–∂–∞
        const collegeHtmlBlock = document.querySelector(`.college-schedule-html[data-college="${collegeName}"]`);
        
        if (collegeHtmlBlock) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π HTML
            displayArea.innerHTML = collegeHtmlBlock.innerHTML;
            currentSchedule = collegeName;
        } else {
            // Fallback: –∑–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ AJAX
            fetch(`/api/schedule/templates/${encodeURIComponent(collegeName)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(html => {
                    displayArea.innerHTML = html;
                    currentSchedule = collegeName;
                })
                .catch(error => {
                    console.error('Error loading schedule:', error);
                    displayArea.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
                });
        }
    }

    function deleteAllSchedules() {
        console.log('deleteAllSchedules called');
        const modal = document.getElementById('deleteModal');
        if (modal) {
            modal.style.display = 'block';
            console.log('Modal displayed');
        } else {
            console.error('Modal not found');
        }
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    function confirmDeleteAll() {
        console.log('confirmDeleteAll called');
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ ID —à–∞–±–ª–æ–Ω–æ–≤
        const templateIds = [];
        document.querySelectorAll('.college-item').forEach(item => {
            const id = item.getAttribute('data-id');
            if (id) {
                templateIds.push(id);
                console.log('Found template ID:', id);
            }
        });

        if (templateIds.length === 0) {
            alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
        const csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
        if (!csrfTokenElement) {
            alert('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const csrfToken = csrfTokenElement.getAttribute('content');
        console.log('CSRF token:', csrfToken ? 'present' : 'missing');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const modal = document.getElementById('deleteModal');
        const modalBody = modal.querySelector('.modal-body');
        modalBody.innerHTML = '<p>–£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π...</p>';

        // –£–¥–∞–ª—è–µ–º –∫–∞–∂–¥—ã–π —à–∞–±–ª–æ–Ω
        Promise.all(templateIds.map(id => {
            const url = `{{ url_for("panel.delete_schedule_template", template_id=0) }}`.replace('/0/', `/${id}/`);
            console.log('Deleting template:', id, 'URL:', url);
            
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `csrf_token=${csrfToken}`
            }).then(response => {
                console.log('Response for template', id, ':', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            });
        })).then(() => {
            console.log('All templates deleted successfully');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.reload();
        }).catch(error => {
            console.error('Error deleting schedules:', error);
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π: ${error.message}`);
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            modalBody.innerHTML = `
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-danger" onclick="confirmDeleteAll()">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
                </div>
            `;
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    window.onclick = function (event) {
        const modal = document.getElementById('deleteModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock %}