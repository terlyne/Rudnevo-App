{% extends "panel/base.html" %}

{% block title %}
–†—É–¥–Ω–µ–≤–æ - –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/panel/schedule/schedule_list.css') }}">
<style>
    .btn-remove-image {
        background: #f44336;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 18px;
        font-size: 15px;
        cursor: pointer;
        margin-top: 10px;
        transition: background 0.2s;
        display: inline-block;
    }

    .btn-remove-image:hover {
        background: #c62828;
    }
</style>
{% endblock %}

{% block container %}
<meta name="csrf-token" content="{{ csrf_token }}">
<div class="schedule-container">
    <div class="schedule-header">
        <div class="header-content">
            <h1>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h1>
        </div>
        <div class="schedule-actions">
            <button id="addCollegeBtn" class="btn btn-secondary">
                <span class="btn-icon">üè´</span>
                –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–¥–∂
            </button>
            <button id="deleteBtn" class="btn btn-danger" style="display: none;">
                <span class="btn-icon">üóëÔ∏è</span>
                –£–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            </button>
        </div>
    </div>

    <div class="schedule-content">
        <div class="colleges-list">
            {% for college in colleges %}
            <div class="college-item" data-id="{{ college.template_id if college.has_schedule else '' }}" data-college="{{ college.name }}" data-has-schedule="{{ 'true' if college.has_schedule else 'false' }}">
                <div class="college-image">
                    {% if college.image_url %}
                        <img src="{{ url_for('panel.college_image', college_id=college.id) }}" alt="{{ college.name }}" class="college-logo">
                    {% else %}
                        <span class="college-emoji">üè´</span>
                    {% endif %}
                </div>
                <h3 class="college-name">{{ college.name }}</h3>
                <p class="schedule-status">
                    {% if college.has_schedule %}
                        –ï—Å—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                    {% else %}
                        –ù–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
                    {% endif %}
                </p>
                <div class="college-actions">
                    {% if not college.has_schedule %}
                    <button class="btn-action upload-schedule-btn" data-college-id="{{ college.id }}" data-college-name="{{ college.name }}" title="–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–æ–ª–ª–µ–¥–∂–∞">üì§</button>
                    {% endif %}
                    
                    <!-- –§–æ—Ä–º–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–ª–ª–µ–¥–∂–∞ -->
                    <form method="POST" action="{{ url_for('panel.college_delete', college_id=college.id) }}" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                        <button type="submit" class="btn-action" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–ª–µ–¥–∂ &quot;{{ college.name }}&quot;? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–ª–µ–¥–∂">üóëÔ∏è</button>
                    </form>
                    
                    {% if college.has_schedule and college.template_id %}
                    <!-- –§–æ—Ä–º–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
                    <form method="POST" action="{{ url_for('panel.delete_schedule_template', template_id=college.template_id) }}" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                        <button type="submit" class="btn-action delete-schedule-btn" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–æ–ª–ª–µ–¥–∂–∞ &quot;{{ college.name }}&quot;? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')" title="–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ">‚ùå</button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="schedule-display">
            <div class="display-header">
                <h2>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>
                <p class="display-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–¥–∂ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</p>
            </div>
            <div class="display-content" id="scheduleDisplay">
                <div class="empty-state">
                    <div class="empty-icon">üìÖ</div>
                    <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</h3>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–¥–∂ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–ª–µ–¥–∂–∞ -->
<div id="collegeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–¥–∂</h2>
            <span class="close" onclick="closeCollegeModal()">&times;</span>
        </div>
        <form id="collegeForm" method="POST" action="{{ url_for('panel.college_create') }}" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <div class="form-group">
                <label for="collegeName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–¥–∂–∞ *</label>
                <input type="text" id="collegeName" name="name" required>
            </div>
            <div class="form-group">
                <label for="collegeImage">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–ª–µ–¥–∂–∞ *</label>
                <div id="imageBlock">
                    <img id="imagePreview" src="" alt="–ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
                        style="display:none;max-width:100%;margin-top:10px;" />
                    <button type="button" id="removeImageBtn" style="display:none;margin-top:10px;"
                        class="btn-remove-image">–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                    <input type="file" id="collegeImage" name="image" accept="image/*" required />
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeCollegeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn-save">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
            <span class="close" onclick="closeDeleteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
        </div>
        <div class="form-actions">
            <button class="btn-cancel" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-delete" onclick="confirmDeleteAll()">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/panel/schedule/schedule_list.js') }}"></script>
<script>
    let currentSchedule = null;

    document.addEventListener('DOMContentLoaded', function () {
        console.log('=== SCHEDULE LIST PAGE LOADED ===');
        
        // –û—Ç–ª–∞–¥–∫–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ ID —à–∞–±–ª–æ–Ω–æ–≤
        const collegeItems = document.querySelectorAll('.college-item');
        console.log(`Found ${collegeItems.length} college items`);
        collegeItems.forEach((item, index) => {
            const id = item.getAttribute('data-id');
            const college = item.getAttribute('data-college');
            console.log(`Item ${index}: ID=${id}, College=${college}`);
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
        updateButtonVisibility();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–ª–µ–¥–∂–∞
        const addCollegeBtn = document.getElementById('addCollegeBtn');
        if (addCollegeBtn) {
            addCollegeBtn.addEventListener('click', function () {
                openCollegeModal();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–∞ –≤ —Ñ–æ—Ä–º–µ –∫–æ–ª–ª–µ–¥–∂–∞
        const collegeImageInput = document.getElementById('collegeImage');
        if (collegeImageInput) {
            collegeImageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('imagePreview');
                        const removeBtn = document.getElementById('removeImageBtn');
                        
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        removeBtn.style.display = 'inline-block';
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª"
                        collegeImageInput.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–µ –∫–æ–ª–ª–µ–¥–∂–∞
        const removeImageBtn = document.getElementById('removeImageBtn');
        if (removeImageBtn) {
            removeImageBtn.onclick = function() {
                const imageInput = document.getElementById('collegeImage');
                imageInput.value = '';
                this.style.display = 'none';
                document.getElementById('imagePreview').style.display = 'none';
                imageInput.style.display = 'block';
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ remove_image
                let removeField = document.getElementById('remove_image');
                if (!removeField) {
                    removeField = document.createElement('input');
                    removeField.type = 'hidden';
                    removeField.name = 'remove_image';
                    removeField.id = 'remove_image';
                    document.getElementById('collegeForm').appendChild(removeField);
                }
                removeField.value = 'true';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        const deleteBtn = document.getElementById('deleteBtn');
        if (deleteBtn) {
            console.log('Delete button found, adding event listener');
            deleteBtn.addEventListener('click', function () {
                console.log('Delete button clicked');
                deleteAllSchedules();
            });
        } else {
            console.error('Delete button not found');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–ª–ª–µ–¥–∂–µ–π
        document.querySelectorAll('.college-item').forEach(item => {
            item.addEventListener('click', function (event) {
                // –ù–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                if (event.target.closest('.college-actions')) {
                    return;
                }
                const collegeName = this.getAttribute('data-college');
                showSchedule(collegeName, this);
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        document.querySelectorAll('.upload-schedule-btn').forEach(btn => {
            btn.addEventListener('click', function (event) {
                event.stopPropagation();
                const collegeId = this.getAttribute('data-college-id');
                const collegeName = this.getAttribute('data-college-name');
                uploadSchedule(collegeId, collegeName);
            });
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –∫–æ–ª–ª–µ–¥–∂
        const firstCollege = document.querySelector('.college-item');
        if (firstCollege) {
            firstCollege.classList.add('active');
        }
    });

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
    function openCollegeModal() {
        const modal = document.getElementById('collegeModal');
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    }

    function closeCollegeModal() {
        const modal = document.getElementById('collegeModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            const form = document.getElementById('collegeForm');
            if (form) {
                form.reset();
            }
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const imageInput = document.getElementById('collegeImage');
            const preview = document.getElementById('imagePreview');
            const removeBtn = document.getElementById('removeImageBtn');
            
            if (imageInput) imageInput.style.display = 'block';
            if (preview) preview.style.display = 'none';
            if (removeBtn) removeBtn.style.display = 'none';
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    window.onclick = function (event) {
        const collegeModal = document.getElementById('collegeModal');
        const deleteModal = document.getElementById('deleteModal');
        
        if (event.target == collegeModal) {
            closeCollegeModal();
        }
        if (event.target == deleteModal) {
            closeDeleteModal();
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeCollegeModal();
            closeDeleteModal();
        }
    });

    function updateButtonVisibility() {
        const hasColleges = document.querySelectorAll('.college-item').length > 0;
        const hasSchedules = document.querySelectorAll('.college-item[data-has-schedule="true"]').length > 0;
        const deleteBtn = document.getElementById('deleteBtn');
        
        if (hasColleges) {
            if (deleteBtn) deleteBtn.style.display = hasSchedules ? 'inline-flex' : 'none';
        } else {
            if (deleteBtn) deleteBtn.style.display = 'none';
        }
    }

    function showSchedule(collegeName, element) {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        document.querySelectorAll('.college-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
        element.classList.add('active');
        
        const displayArea = document.getElementById('scheduleDisplay');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–ª–ª–µ–¥–∂–∞
        const hasSchedule = element.getAttribute('data-has-schedule') === 'true';
        
        if (!hasSchedule) {
            displayArea.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìÖ</div>
                    <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</h3>
                    <p>–î–ª—è –∫–æ–ª–ª–µ–¥–∂–∞ "${collegeName}" —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</p>
                </div>
            `;
            currentSchedule = null;
            return;
        }
        
        // –ï—Å–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ —ç—Ç–æ —Ç–æ—Ç –∂–µ –∫–æ–ª–ª–µ–¥–∂, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ
        if (currentSchedule === collegeName) {
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        displayArea.innerHTML = `
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</p>
            </div>
        `;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ AJAX
        const collegeId = element.getAttribute('data-id');
        fetch(`/api/schedule/templates/${collegeId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(html => {
                displayArea.innerHTML = html;
                currentSchedule = collegeId;
            })
            .catch(error => {
                console.error('Error loading schedule:', error);
                displayArea.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
            });
    }

    function deleteAllSchedules() {
        console.log('deleteAllSchedules called');
        const modal = document.getElementById('deleteModal');
        if (modal) {
            modal.style.display = 'block';
            console.log('Modal displayed');
        } else {
            console.error('Modal not found');
        }
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    function confirmDeleteAll() {
        console.log('confirmDeleteAll called');
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ ID —à–∞–±–ª–æ–Ω–æ–≤
        const templateIds = [];
        document.querySelectorAll('.college-item[data-has-schedule="true"]').forEach(item => {
            const id = item.getAttribute('data-id');
            if (id) {
                templateIds.push(id);
                console.log('Found template ID:', id);
            }
        });

        if (templateIds.length === 0) {
            alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
        const csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
        if (!csrfTokenElement) {
            alert('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const csrfToken = csrfTokenElement.getAttribute('content');
        console.log('CSRF token:', csrfToken ? 'present' : 'missing');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const modal = document.getElementById('deleteModal');
        const modalBody = modal.querySelector('.modal-body');
        modalBody.innerHTML = '<p>–£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π...</p>';

        // –£–¥–∞–ª—è–µ–º –∫–∞–∂–¥—ã–π —à–∞–±–ª–æ–Ω
        Promise.all(templateIds.map(id => {
            const url = `{{ url_for("panel.delete_schedule_template", template_id=0) }}`.replace('/0/', `/${id}/`);
            console.log('Deleting template:', id, 'URL:', url);
            
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `csrf_token=${csrfToken}`
            }).then(response => {
                console.log('Response for template', id, ':', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            });
        })).then(() => {
            console.log('All templates deleted successfully');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.reload();
        }).catch(error => {
            console.error('Error deleting schedules:', error);
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π: ${error.message}`);
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            modalBody.innerHTML = `
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-danger" onclick="confirmDeleteAll()">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
                </div>
            `;
        });
    }

    function uploadSchedule(collegeId, collegeName) {
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π input –¥–ª—è —Ñ–∞–π–ª–∞
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.xlsx,.xls';
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã Excel (.xlsx, .xls)');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º FormData –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
            const formData = new FormData();
            formData.append('file', file);
            
            // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
            const csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
            if (csrfTokenElement) {
                formData.append('csrf_token', csrfTokenElement.getAttribute('content'));
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const displayArea = document.getElementById('scheduleDisplay');
            displayArea.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è ${collegeName}...</p>
                </div>
            `;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('/api/schedule/upload-excel', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Schedule uploaded successfully:', data);
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
                window.location.reload();
            })
            .catch(error => {
                console.error('Error uploading schedule:', error);
                displayArea.innerHTML = `
                    <div class="error">
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            })
            .finally(() => {
                // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π input
                document.body.removeChild(fileInput);
            });
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º input –≤ DOM –∏ –∫–ª–∏–∫–∞–µ–º –ø–æ –Ω–µ–º—É
        document.body.appendChild(fileInput);
        fileInput.click();
    }
</script>
{% endblock %}