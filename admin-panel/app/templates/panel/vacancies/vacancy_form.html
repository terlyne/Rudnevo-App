{% extends "panel/base.html" %}

{% block title %}
Руднево - {% if is_edit %}Редактирование{% else %}Создание{% endif %} вакансии
{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/panel/vacancies/vacancy_form.css') }}">
{% endblock %}

{% block container %}
<div class="form-header">
    <h1>{% if is_edit %}Редактирование{% else %}Создание{% endif %} вакансии</h1>
    <a href="{{ url_for('panel.vacancies_list') }}" class="btn-back">← Назад к списку</a>
</div>

<div class="form-container">
    <form method="POST" class="vacancy-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <div class="form-section">
            <h3>Основная информация</h3>

            <div class="form-group">
                <label for="title">Название вакансии *</label>
                <input type="text" id="title" name="title" required value="{{ vacancy.title if vacancy else '' }}"
                    placeholder="Введите название вакансии">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="direction">Направление *</label>
                    <select id="direction" name="direction" required>
                        <option value="">Выберите направление</option>
                        <option value="Электроника" {% if vacancy and vacancy.direction=='Электроника' %}selected{%
                            endif %}>Электроника</option>
                        <option value="Машиностроение" {% if vacancy and vacancy.direction=='Машиностроение'
                            %}selected{% endif %}>Машиностроение</option>
                        <option value="Автоматизация производства" {% if vacancy and
                            vacancy.direction=='Автоматизация производства' %}selected{% endif %}>Автоматизация
                            производства</option>
                        <option value="Авиационная промышленность и беспилотные авиационные системы" {% if vacancy and
                            vacancy.direction=='Авиационная промышленность и беспилотные авиационные системы'
                            %}selected{% endif %}>Авиационная промышленность и беспилотные авиационные системы</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="speciality">Специальность/профессия *</label>
                    <select id="speciality" name="speciality" required>
                        <option value="">Выберите специальность</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="description">Описание вакансии *</label>
                <textarea id="description" name="description" rows="6" required
                    placeholder="Подробное описание вакансии, обязанности, задачи">{{ vacancy.description if vacancy else '' }}</textarea>
            </div>

            <div class="form-group">
                <label for="requirements">Требования *</label>
                <textarea id="requirements" name="requirements" rows="4" required
                    placeholder="Требования к кандидату, навыки, опыт">{{ vacancy.requirements if vacancy else '' }}</textarea>
            </div>
        </div>

        <div class="form-section">
            <h3>Условия работы</h3>

            <div class="form-row">
                <div class="form-group">
                    <label for="work_format">Формат работы *</label>
                    <select id="work_format" name="work_format" required>
                        <option value="">Выберите формат</option>
                        <option value="Очно" {% if vacancy and vacancy.work_format=='Очно' %}selected{% endif %}>Очно
                        </option>
                        <option value="Удаленно" {% if vacancy and vacancy.work_format=='Удаленно' %}selected{% endif
                            %}>Удаленно</option>
                        <option value="Гибрид" {% if vacancy and vacancy.work_format=='Гибрид' %}selected{% endif %}>
                            Гибрид</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="required_amount">Количество мест *</label>
                    <input type="number" id="required_amount" name="required_amount" min="1" required
                        value="{{ vacancy.required_amount if vacancy else 1 }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="start">Дата начала *</label>
                    <input type="date" id="start" name="start" required value="{{ vacancy.start if vacancy else '' }}">
                </div>

                <div class="form-group">
                    <label for="end">Дата окончания *</label>
                    <input type="date" id="end" name="end" required value="{{ vacancy.end if vacancy else '' }}">
                </div>
            </div>

            <div class="form-group">
                <label for="chart">График работы *</label>
                <textarea id="chart" name="chart" rows="3" required
                    placeholder="График работы, часы, дни недели">{{ vacancy.chart if vacancy else '' }}</textarea>
            </div>
        </div>

        <div class="form-section">
            <h3>Контактная информация</h3>

            <div class="form-group">
                <label for="contact_person">Контактное лицо *</label>
                <input type="text" id="contact_person" name="contact_person" required value="{{ vacancy.contact_person if vacancy else '' }}" placeholder="Информация о контактном лице (ФИО, телефон, email и т.д.)">
            </div>
        </div>

        <div class="form-section">
            <h3>Публикация</h3>

            <div class="form-group checkbox-group">
                <label class="checkbox-label vacancy-checkbox-label">
                    <input type="checkbox" id="is_hidden" name="is_hidden" {% if vacancy and vacancy.is_hidden
                        %}checked{% endif %}>
                    <span class="checkmark"></span>
                    Скрыть вакансию (не показывать публично)
                </label>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-submit">
                {% if is_edit %}Сохранить изменения{% else %}Создать вакансию{% endif %}
            </button>
            <a href="{{ url_for('panel.vacancies_list') }}" class="btn-cancel">Отмена</a>
        </div>
    </form>
</div>

<script>
    // Получаем элементы формы
    const startDateInput = document.getElementById('start');
    const endDateInput = document.getElementById('end');
    const form = document.querySelector('.vacancy-form');

    // Установка минимальной даты сегодня
    const today = new Date().toISOString().split('T')[0];
    startDateInput.min = today;
    endDateInput.min = today;

    // Функция для показа ошибки
    function showDateError(message) {
        // Удаляем предыдущие ошибки
        const existingError = document.querySelector('.date-error');
        if (existingError) {
            existingError.remove();
        }

        // Добавляем класс ошибки к полям
        startDateInput.parentNode.classList.add('has-error');
        endDateInput.parentNode.classList.add('has-error');

        // Создаем элемент ошибки
        const errorDiv = document.createElement('div');
        errorDiv.className = 'date-error';
        errorDiv.textContent = message;

        // Вставляем ошибку после поля даты окончания
        endDateInput.parentNode.appendChild(errorDiv);
    }

    // Функция для скрытия ошибки
    function hideDateError() {
        const existingError = document.querySelector('.date-error');
        if (existingError) {
            existingError.remove();
        }

        // Убираем класс ошибки с полей
        startDateInput.parentNode.classList.remove('has-error');
        endDateInput.parentNode.classList.remove('has-error');
    }

    // Валидация даты начала
    startDateInput.addEventListener('change', function () {
        const startDate = this.value;

        if (startDate) {
            // Устанавливаем минимальную дату для поля "конец" равной дате начала
            endDateInput.min = startDate;

            // Если дата окончания меньше даты начала, сбрасываем её
            if (endDateInput.value && endDateInput.value < startDate) {
                endDateInput.value = startDate;
                showDateError('Дата окончания автоматически установлена равной дате начала');
                setTimeout(hideDateError, 3000); // Скрываем сообщение через 3 секунды
            } else {
                hideDateError();
            }
        }
    });

    // Валидация даты окончания
    endDateInput.addEventListener('change', function () {
        const endDate = this.value;
        const startDate = startDateInput.value;

        if (endDate && startDate) {
            if (endDate < startDate) {
                showDateError('Дата окончания не может быть раньше даты начала');
                this.value = startDate;
            } else {
                hideDateError();
            }
        }
    });

    // Валидация формы перед отправкой
    form.addEventListener('submit', function (e) {
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;

        if (startDate && endDate) {
            if (startDate >= endDate) {
                e.preventDefault();
                showDateError('Дата начала должна быть раньше даты окончания');
                return false;
            }
        }

        hideDateError();
    });

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        // Если есть значения дат, устанавливаем ограничения
        if (startDateInput.value) {
            endDateInput.min = startDateInput.value;
        }
        if (endDateInput.value) {
            startDateInput.max = endDateInput.value;
        }

        // Проверяем валидность существующих дат
        if (startDateInput.value && endDateInput.value) {
            if (startDateInput.value >= endDateInput.value) {
                showDateError('Дата начала должна быть раньше даты окончания');
            }
        }
    });

    // Данные по направлениям и специальностям
    const specialityOptions = {
        'Электроника': [
            'Монтажник радиоэлектронной аппаратуры и приборов',
            'Слесарь-сборщик радиоэлектронной аппаратуры и приборов',
            'Регулировщик радиоэлектронной аппаратуры и приборов',
            'Слесарь-сборщик радиоэлектронной аппаратуры и приборов'
        ],
        'Машиностроение': [
            'Слесарь механосборочных работ',
            'Токарь',
            'Фрезеровщик',
            'Оператор станков с ПУ',
            'Станочник широкого профиля',
            'Сварщик (ручной и частично механизированной сварки (наплавки))',
            'Наладчик станков и оборудования в механообработке',
            'Специалист ОТК'
        ],
        'Автоматизация производства': [
            'Специалист по обслуживанию мехатронных и роботизированных комплексов',
            'Слесарь контрольно-измерительных приборов и автоматики',
            'Специалист по аддитивным технологиям'
        ],
        'Авиационная промышленность и беспилотные авиационные системы': [
            'Монтажник электрооборудования летательных аппаратов',
            'Слесарь-сборщик авиационной техники',
            'Слесарь-сборщик авиационных изделий из композитных материалов',
            'Оператор беспилотных авиационных систем до 30 кг'
        ]
    };

    const directionSelect = document.getElementById('direction');
    const specialitySelect = document.getElementById('speciality');

    const selectedSpeciality = "{{ vacancy.speciality if vacancy and vacancy.speciality else '' }}";

    function updateSpecialities() {
        const direction = directionSelect.value;
        const specs = specialityOptions[direction] || [];
        specialitySelect.innerHTML = '<option value="">Выберите специальность</option>';
        specs.forEach(spec => {
            const option = document.createElement('option');
            option.value = spec;
            option.textContent = spec;
            if (spec === selectedSpeciality) {
                option.selected = true;
            }
            specialitySelect.appendChild(option);
        });
    }

    directionSelect.addEventListener('change', updateSpecialities);

    document.addEventListener('DOMContentLoaded', function () {
        updateSpecialities();
    });
</script>
{% endblock %}